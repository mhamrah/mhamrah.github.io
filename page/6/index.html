<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Adventures in HttpContext &middot; All the stuff after &#39;Hello, World&#39;
    
  </title>

  
  <link rel="stylesheet" href="http://blog.michaelhamrah.com/css/poole.css">
  <link rel="stylesheet" href="http://blog.michaelhamrah.com/css/syntax.css">
  <link rel="stylesheet" href="http://blog.michaelhamrah.com/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.michaelhamrah.com/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="http://blog.michaelhamrah.com/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.michaelhamrah.com/atom.xml">
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Michael Hamrah</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item  active " href="http://blog.michaelhamrah.com/">Home</a>
    <a class="sidebar-nav-item " href="http://blog.michaelhamrah.com/post">Posts</a>

    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a class="sidebar-nav-item " href="http://blog.michaelhamrah.com/about/">About</a>
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="http://linkedin.com/in/hamrah">LinkedIn</a>
    <a class="sidebar-nav-item" href="http://twitter.com/mhamrah">@mhamrah</a>
    <a class="sidebar-nav-item" href="http://github.com/mhamrah">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="http://blog.michaelhamrah.com/" title="Home">Adventures in HttpContext</a>
            <small>All the stuff after &#39;Hello, World&#39;</small>
          </h3>
        </div>
      </div>

      <div class="container content">





<div class="posts">
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/12/machinist-2-mongoid-embeds_many-goodness/">Machinist 2 &#43; Mongoid &#43; Embeds_Many Goodness</a></h1>
        <span class="post-date">Dec 10 2010</span>
        <p>I had a heck of a time getting fixtures working with <a href="http://mongoid.org/">Mongoid</a> when it came to a required embeds<em>many property.  No matter what I did, I kept getting an error: &#8220;_Access to the collection for</em> XXX <em>is not allowed since it is an embedded document, please access a collection from the root document.&#8221;</em></p>

<p>Then I stumbled upon <a href="https://github.com/notahat/machinist">Machinist</a> v2 and the <a href="https://github.com/nmerouze/machinist_mongo">machinist_mongo</a> gem which solved the problem.  And it had a nice API, to boot!</p>

<p><strong>Getting Started</strong></p>

<p>As of this post, you&#8217;ll need to pull the machinist_mongo gem directly from git and get the machinist2 branch.  That&#8217;s easy with Rails 3:</p>

<p><strong>gem &#8216;machinist_mongo&#8217;, :git =&gt; &#8216;<a href="https://github.com/nmerouze/machinist_mongo.git&amp;#8217">https://github.com/nmerouze/machinist_mongo.git&amp;#8217</a>;, :require =&gt; &#8216;machinist/mongoid&#8217;, :branch =&gt; &#8216;machinist2&#8242;</strong></p>

<p>Next, run</p>

<p><code class="syntax bash">bundle</code></p>

<p>to update your gems.</p>

<p>I&#8217;m using RSpec, so I put my blueprints in the spec/support/ directory so they get automatically loaded. Let&#8217;s say I have a User class with a :username and an embeds_many :authentications property (as if you&#8217;re following the Railscasts episode on using Devise and Omniauth).  The blueprint will look like this:</p>

<pre class="syntax ruby">Authentication.blueprint do
     uid { "user#{serial_number}" }
     provider { "machinist" }
end

User.blueprint do
     username { "user#{serial_number}" }
     authentications(1) { Authentication.make }
end
</pre>

<p>My authentications blueprint sets a unique id using the #{serial_number} counter in machinist 2. Then I&#8217;m declaring an array of one item in my authentications array, and calling Authentication.make to load the Authentication blueprint. This essentially lazy loads the authentications property via the root document, which is exactly what Mongoid wants, as there&#8217;s no Authentications table or root-level document.</p>

<p>Now you can build away using Machinist 2&#8217;s User.make (for creating an object without saving it) or make! (which makes and saves the object).</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/11/updated-visual-studio-html5openid-template-now-with-mvc-3-rc-and-html5-boilerplate-0-9-5/">Updated: Visual Studio Html5OpenId Template.  Now with MVC 3 RC and Html5 Boilerplate 0.9.5</a></h1>
        <span class="post-date">Nov 15 2010</span>
        <p><a href="http://www.michaelhamrah.com/blog/2010/08/mvc-3-preview-1-vs-2010-template-w-razor-html-5-boilerplate-and-openid-authentication/">In my previous I created a Visual Studio Template which uses OpenId via DotNetOpenAuth and Html5 Boilerplate by Paul Irish</a>.</p>

<p><del datetime="2011-02-17T16:21:27+00:00">That template has been updated to use MVC 3 RC and Html5 Boilerplate .0.9.5.</del> That template has been updated to use MVC 3 full and html5 boilerplate&#8217;s master as of 2/17/11.</p>

<p><a href="https://github.com/downloads/mhamrah/Html5OpenIdTemplate/Html5OpenIdTemplate.zip">You can grab the new template</a> or <a href="https://github.com/mhamrah/Html5OpenIdTemplate">view/clone the project on Github.</a></p>

<p><a href="http://www.michaelhamrah.com/blog/2010/08/mvc-3-preview-1-vs-2010-template-w-razor-html-5-boilerplate-and-openid-authentication/">Read the original post to learn what it&#8217;s all about.</a></p>

<p><span style="font-size: 13.2px;"></span></p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/11/rails-fixing-bundle-no-metadata-found-issues/">Rails: Fixing Bundle “No Metadata Found” issues</a></h1>
        <span class="post-date">Nov 14 2010</span>
        <p>In playing around with Rails this weekend, I ran into an annoying error when trying to set up some bundles- specifically with Webrat and Cucumber, which I found very odd:</p>

<pre class="syntax bash">/Users/Michael/.rvm/rubies/ruby-1.9.2-p0/lib/ruby/1.9.1/rubygems/package/tar_input.rb:111:in
`initialize': No metadata found! (Gem::Package::FormatError)
</pre>

<p>Removing the dependencies in my Gemfile fixed the issue, but obviously left me without Cucumber and Webrat gems.</p>

<p>Googling didn&#8217;t provide an immediate solution to my problem, which is why I&#8217;m writing this post. <a href="https://github.com/carlhuda/bundler/issuesearch?state=closed&amp;q=metadata#issue/603">An issue hidden in the Bundle Github tracker had a solution</a>: delete the cache directory in your Ruby&#8217;s gem directory. The problem isn&#8217;t necessarily specific to Webrat or Cucumber; the problem appears to be when the cache directory gets out of sync with the actual repository, and gems which should be installable cannot be found.</p>

<p>After deleting the cache, <strong>bundle install</strong> ran without error with my new Webrat and Cucumber gems.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/11/expressions-and-lambdas-oh-my/">Expressions and Lambdas: Oh My!</a></h1>
        <span class="post-date">Nov 13 2010</span>
        <p>I&#8217;ve been working on a toolkit called <a href="https://github.com/mhamrah/Redaculous">Redaculous</a>&#8211; it&#8217;s a .NET Library for the really cool key/value store <a href="http://code.google.com/p/redis/">Redis</a>.  It&#8217;s built on top of the <a href="http://code.google.com/p/servicestack/wiki/ServiceStackRedis">ServiceStack.Redis</a> library, which provides various .NET clients for Redis.  Redaculous is meant to make aggregating Redis commands a little easier- but don&#8217;t get too excited.  The project __is in its infancy, and will undergo many changes, if it even gets off the ground.  This post isn&#8217;t about Redis nor Redaculous- it&#8217;s about how parts of Redaculous leverage <a href="http://msdn.microsoft.com/en-us/library/bb506649.aspx">Expressions</a> and <a href="http://msdn.microsoft.com/en-us/library/bb397687.aspx">Lambdas</a> to drive a lot of the functionality Redaculous is meant to provide, and how you can leverage Expressions to make your programming life easier.  ASP.NET MVC and lots of other great frameworks do it, so why can&#8217;t you?</p>

<p>The problem was simple:  I have a class, with a bunch of properties, and those properties have values.  In order to put them into Redis, I need to know the property name and the value it contains.  I need to know, at runtime, that myObj.SomeProperty has a property called &#8220;SomeProperty&#8221; and the value of that property.  This is a problem shared with most serialization tools and ORM mappers:  how does a &#8220;SomeProperty&#8221; make it to a column in table in a database, or make it to a node in xml?</p>

<p>This problem can (and has been) solved in a variety of ways.  The most common was attributes to decorate classes and properties- which is how WCF constructs contracts or how some ORM toolkits work.  But that&#8217;s extremely intrusive, in this pseudo example which combines WCF and DataAccess :</p>

<pre class="syntax c# escaped">[Table("DtoTb")]
[DataContract]
public class Dto
{
     [PrimaryKey]
     [DataMember]
     public int Id { get; set; }

     [ColumnName("Name")]
     [DataMember]
     public string Name { get; set; }
}
</pre>

<p>There&#8217;s a weird combination of data storage and data definition which goes on in toolkits which use that approach.  It&#8217;s not really a smooth way to operate- and the approach falls out when the model greatly diverages from the underlying table, or when a class has numerous other complex types.  Worse, when we want to also expose that class via WCF, we&#8217;re essentially tacking on both data access description and web service schema description.  How many attributes can you tack on there? Validation attributes, too?</p>

<p>Another approach is to use code-generation.  This is essentially what Linq-to-Sql does; it provides the underlying property descriptions at design time, saving a lot of manual typing.  I&#8217;m not a big fan of code generators; they have their place, but you lose a lot of control in defining explicit functionality.  You&#8217;re boxed into what is generated and most customizations usually don&#8217;t fit in well: when you stray outside of what the code generator provides (or even outside of what the core generation is focused on) you find yourself trying to shove a square peg in a round hole.</p>

<p>The best approach is to do what great tools like <a href="https://github.com/atheken/NoRM">Norm</a>, <a href="http://fluentnhibernate.org/">Fluent NHibernate,</a> <a href="http://automapper.codeplex.com/">AutoMapper</a>, and .MVC&#8217;s Html helpers do: they use <a href="http://msdn.microsoft.com/en-us/library/bb397687.aspx">Expressions</a>.  Most often the configuration is offloaded to separate classes which rely heavily on Expressions for property introspection.  This allows an end user to write code like:</p>

<pre class="syntax c# escaped">//For MVC:
Html.TextBoxFor(m =&gt; m.ProductName);
//Or for Fluent NHibernate:
Id(x =&gt; x.ImageId);
</pre>

<p>The TextBoxFor creates an input html element with a name=&#8221;ProductName&#8221; attribute; the Id() says NHIbernate should use a class&#8217;s ImageId Property as the Id for the table.</p>

<p>Expressions where introduced in .NET 3.5, and have been heavily leveraged ever since to provide a level of meta-programming which previously didn&#8217;t exist in the .NET world.   Expressions greatly differ from Reflection by the fact Expressions are code which has been parsed into a set of various descriptive classes, while Reflection is compiled code which has been deconstructed into a descriptive semantic. An Expression statement will not actually &#8220;do&#8221; anything.  It can, however, be compiled into a callable function- which is the core advantage over Reflection.  With Expressions, you can have both the description of code and the actual, runnable code together.  Most frameworks create a package or container around the two as a performance optimization- it prevents an application from having to compile the expression multiple times.  The performance is much greater than using reflection to dynamically invoke or inspect properties.</p>

<p><strong>How It Works</strong></p>

<p>Expressions and Lambdas go hand-in-hand, and can often be confused with one another. Let&#8217;s take a look at the following code:</p>

<pre class="syntax c# escaped">Expression&lt;Func&lt;SomeDto, string&gt;&gt; expressionLambda = m =&gt; m.SomeStringProp;
Func&lt;SomeDto, string&gt;&gt; funcLambda = m =&gt; m.SomeStringProp;
</pre>

<p>What&#8217;s the difference between the two?  It&#8217;s the same value, right?  Well, running that snippet in Visual Studio, and viewing the debugger properties, you&#8217;ll find two different results for the m=&gt;m.SomeStringProp statement. m=&gt;m.SomeStringProp is the lambda: it&#8217;s simply an alternative way of writing C# for various purposes. Usually, Lambdas are either Func or Action statements used as an alternative for delegate methods. The compiler will generate runnable IL code for the m =&gt; m.SomeStringProp statement and create a callable method expecting an instance of SomeDto as the input. In the above example, you could get the value of a SomeStringProp using funcLambda like so:</p>

<pre class="syntax c# escaped">var dto = new SomeDto() { SomeStringProp = "Hell Yeah!" };
funcLambda(dto); //Returns "Hell Yeah!"
</pre>

<p>This can provide a level of agnosticism by passing around logic as variables in a much easier way than vanilla delegates.</p>

<p>Expressions, on the other hand, don&#8217;t compile into runnable IL code.  You can&#8217;t write <em>funcExpression(dto)</em> in the same was a normal lambda.  The compiler does something different: it actually parses the m=&gt;m.SomeStringProp into various expression components which can be traversed, manipulated, rearranged and even compiled into a callable action, as if it were a Func all along. The [I&#8217;ve been working on a toolkit called <a href="https://github.com/mhamrah/Redaculous">Redaculous</a>&#8211; it&#8217;s a .NET Library for the really cool key/value store <a href="http://code.google.com/p/redis/">Redis</a>.  It&#8217;s built on top of the <a href="http://code.google.com/p/servicestack/wiki/ServiceStackRedis">ServiceStack.Redis</a> library, which provides various .NET clients for Redis.  Redaculous is meant to make aggregating Redis commands a little easier- but don&#8217;t get too excited.  The project __is in its infancy, and will undergo many changes, if it even gets off the ground.  This post isn&#8217;t about Redis nor Redaculous- it&#8217;s about how parts of Redaculous leverage <a href="http://msdn.microsoft.com/en-us/library/bb506649.aspx">Expressions</a> and <a href="http://msdn.microsoft.com/en-us/library/bb397687.aspx">Lambdas</a> to drive a lot of the functionality Redaculous is meant to provide, and how you can leverage Expressions to make your programming life easier.  ASP.NET MVC and lots of other great frameworks do it, so why can&#8217;t you?</p>

<p>The problem was simple:  I have a class, with a bunch of properties, and those properties have values.  In order to put them into Redis, I need to know the property name and the value it contains.  I need to know, at runtime, that myObj.SomeProperty has a property called &#8220;SomeProperty&#8221; and the value of that property.  This is a problem shared with most serialization tools and ORM mappers:  how does a &#8220;SomeProperty&#8221; make it to a column in table in a database, or make it to a node in xml?</p>

<p>This problem can (and has been) solved in a variety of ways.  The most common was attributes to decorate classes and properties- which is how WCF constructs contracts or how some ORM toolkits work.  But that&#8217;s extremely intrusive, in this pseudo example which combines WCF and DataAccess :</p>

<pre class="syntax c# escaped">[Table("DtoTb")]
[DataContract]
public class Dto
{
     [PrimaryKey]
     [DataMember]
     public int Id { get; set; }

     [ColumnName("Name")]
     [DataMember]
     public string Name { get; set; }
}
</pre>

<p>There&#8217;s a weird combination of data storage and data definition which goes on in toolkits which use that approach.  It&#8217;s not really a smooth way to operate- and the approach falls out when the model greatly diverages from the underlying table, or when a class has numerous other complex types.  Worse, when we want to also expose that class via WCF, we&#8217;re essentially tacking on both data access description and web service schema description.  How many attributes can you tack on there? Validation attributes, too?</p>

<p>Another approach is to use code-generation.  This is essentially what Linq-to-Sql does; it provides the underlying property descriptions at design time, saving a lot of manual typing.  I&#8217;m not a big fan of code generators; they have their place, but you lose a lot of control in defining explicit functionality.  You&#8217;re boxed into what is generated and most customizations usually don&#8217;t fit in well: when you stray outside of what the code generator provides (or even outside of what the core generation is focused on) you find yourself trying to shove a square peg in a round hole.</p>

<p>The best approach is to do what great tools like <a href="https://github.com/atheken/NoRM">Norm</a>, <a href="http://fluentnhibernate.org/">Fluent NHibernate,</a> <a href="http://automapper.codeplex.com/">AutoMapper</a>, and .MVC&#8217;s Html helpers do: they use <a href="http://msdn.microsoft.com/en-us/library/bb397687.aspx">Expressions</a>.  Most often the configuration is offloaded to separate classes which rely heavily on Expressions for property introspection.  This allows an end user to write code like:</p>

<pre class="syntax c# escaped">//For MVC:
Html.TextBoxFor(m =&gt; m.ProductName);
//Or for Fluent NHibernate:
Id(x =&gt; x.ImageId);
</pre>

<p>The TextBoxFor creates an input html element with a name=&#8221;ProductName&#8221; attribute; the Id() says NHIbernate should use a class&#8217;s ImageId Property as the Id for the table.</p>

<p>Expressions where introduced in .NET 3.5, and have been heavily leveraged ever since to provide a level of meta-programming which previously didn&#8217;t exist in the .NET world.   Expressions greatly differ from Reflection by the fact Expressions are code which has been parsed into a set of various descriptive classes, while Reflection is compiled code which has been deconstructed into a descriptive semantic. An Expression statement will not actually &#8220;do&#8221; anything.  It can, however, be compiled into a callable function- which is the core advantage over Reflection.  With Expressions, you can have both the description of code and the actual, runnable code together.  Most frameworks create a package or container around the two as a performance optimization- it prevents an application from having to compile the expression multiple times.  The performance is much greater than using reflection to dynamically invoke or inspect properties.</p>

<p><strong>How It Works</strong></p>

<p>Expressions and Lambdas go hand-in-hand, and can often be confused with one another. Let&#8217;s take a look at the following code:</p>

<pre class="syntax c# escaped">Expression&lt;Func&lt;SomeDto, string&gt;&gt; expressionLambda = m =&gt; m.SomeStringProp;
Func&lt;SomeDto, string&gt;&gt; funcLambda = m =&gt; m.SomeStringProp;
</pre>

<p>What&#8217;s the difference between the two?  It&#8217;s the same value, right?  Well, running that snippet in Visual Studio, and viewing the debugger properties, you&#8217;ll find two different results for the m=&gt;m.SomeStringProp statement. m=&gt;m.SomeStringProp is the lambda: it&#8217;s simply an alternative way of writing C# for various purposes. Usually, Lambdas are either Func or Action statements used as an alternative for delegate methods. The compiler will generate runnable IL code for the m =&gt; m.SomeStringProp statement and create a callable method expecting an instance of SomeDto as the input. In the above example, you could get the value of a SomeStringProp using funcLambda like so:</p>

<pre class="syntax c# escaped">var dto = new SomeDto() { SomeStringProp = "Hell Yeah!" };
funcLambda(dto); //Returns "Hell Yeah!"
</pre>

<p>This can provide a level of agnosticism by passing around logic as variables in a much easier way than vanilla delegates.</p>

<p>Expressions, on the other hand, don&#8217;t compile into runnable IL code.  You can&#8217;t write <em>funcExpression(dto)</em> in the same was a normal lambda.  The compiler does something different: it actually parses the m=&gt;m.SomeStringProp into various expression components which can be traversed, manipulated, rearranged and even compiled into a callable action, as if it were a Func all along. The]<a href="http://msdn.microsoft.com/en-us/library/bb506649.aspx">4</a> has all of the available types a lambda expression can be broken down into.  Essentially, a hierarchal tree is generated, with each distinct component of the lambda expression being represented by one of the many Expression classes.  These <span style="font-size: 13.2px;">classes can be used to inspect various aspects of that part.  The above lambda is simply a <a href="http://msdn.microsoft.com/en-us/library/system.linq.expressions.memberexpression.aspx">MemberExpression</a>, which is used for field and properties. Using MemberExpressions you can get the name of the Member, the Property Type, you can use the NodeType property- that&#8217;s available with all Expression classes- to learn that it&#8217;s a MemberAccess call.</span></p>

<p><span style="font-size: 13.2px;">Because Expressions can be compiled into runnable code, frameworks get the best of both worlds: metadata about the call, and the call itself.  This is the precisely how ASP.NET MVC Html Helpers are built: that TextBoxFor method takes in an expression which it uses to generate the Html output. The Html helpers in MVC inspect the input expression to figure out what the name of the property for the html name attribute value, and then it runs the compiled expression against the current ViewModel object to get the value for the value html attribute.  The expression metadata and compiled function is actual cached in various static classes for performance: you don&#8217;t want to have to compile the expression every time you use it.  The performance is much better than using reflection alone.</span></p>

<p>Redaculous is using Expressions to avoid the magic string conundrum- by using expressions, Redaculous can parse a statement like &#8220;m = m.Name&#8221; and know it should put the value of a class&#8217;s Name property in the store using a key involving the word &#8220;Name&#8221; in some way. You should explore the <a href="http://aspnet.codeplex.com/wikipage?title=MVC&amp;referringTitle=Home">MVC Framework&#8217;s source code</a> to dig in to how they&#8217;re using expressions for strongly typed helpers. Both Norm and Automapper have some pretty straightforward usage too. By inspecting how other tools use these features you can more easily integrate them into your own projects- and increase productivity by eliminating redundant code and code smells involving magic strings.</p>

<p>Other languages, like Ruby, have a similar level of functionality built in. This is inherit in all dynamic languages: functionality to not only provide an operation, but functionality to describe that operation as well.  I still get some hits on my <a href="http://www.michaelhamrah.com/blog/2009/02/digging-into-ruby-on-rails-from-c-and-mvc-aspnet-mvc/">ASP.NET MVC and Rails</a> article, and I&#8217;d say one of the biggest differences is how Rails, and Ruby in general, use dynamic language features like code metadata to drive functionality.  .NET has always had reflection, but expressions provide a much easier, and much more performant way of dealing with meta-programming.  <span style="font-size: 13.2px;">Expressions provide a core of the functionality in the Dynamic Language Runtime and have always been a strong part of Linq&#8217;s roots.  DLR capabilities, using expressions, will continue to increase its surface area in the .NET world and should be a part of any developers toolkit.</span></p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/09/quicktip-use-commonservicelocator-and-mvcservicelocator-together-in-asp-net-mvc-3-projects/">QuickTip: Use CommonServiceLocator and MvcServiceLocator together in ASP.NET MVC 3 Pre-Release Projects</a></h1>
        <span class="post-date">Sep 23 2010</span>
        <p><strong>UPDATE: This post is outdated since ASP.NET MVC Beta.  Use the DependencyResolver static class instead.</strong></p>

<p>The integration of the CommonServiceLocator pattern within ASP.NET MVC is a positive step forward for the .MVC framework. Dependency management via ServiceLocation is a smart way to go, especially for large codebases with complex dependency needs. ServiceLocation keeps constructors clean, and prevents bloat in higher-level classes which don&#8217;t need to know about lower-level dependencies.</p>

<p>However, the fact that .MVC now has its own ServiceLocation infrastructure, via the System.Web.Mvc.IServiceLocator interface, is a little troublesome for code which already uses the Microsoft CommonServiceLocator class found in the Unity Enterprise Application Block. But don&#8217;t fret- luckily, the IServiceLocator interface is exactly the same in the System.Web.Mvc namespace and the Microsoft.Practices.ServiceLocation namespace. This means you can have one class implement both interface simultaneously, like so:</p>

<pre class="brush: csharp; title: ; notranslate" title="">public class  SomeServiceLocatorWrapper : System.Web.Mvc.IServiceLocator, Microsoft.Practices.ServiceLocation.IServiceLocator
{
 //Implicity Implementation of Methods
}
</pre>

<p>What&#8217;s even easier is when there&#8217;s already a wrapper class around the IServiceLocator for you, such as the one provided by Unity via the UnityServiceLocator class in Microsoft.Practices.Unity&#8217;s namespace. The following code below provides all the functionality you need to use both ServiceLocators:</p>

<pre class="brush: csharp; title: ; notranslate" title="">public class UnityMvcServiceLocator : UnityServiceLocator, System.Web.Mvc.IServiceLocator
{
 public UnityMvcServiceLocator(IUnityContainer container)
 : base(container)
 {

 }

}
</pre>

<p>Once you have that class in place, then it&#8217;s just a matter of hooking both up in your Global.asax file like so:</p>

<pre class="brush: csharp; title: ; notranslate" title="">//In Global.asax's Application_Start hook:
var container = UnityContainerBuilder.CreateContainer();
var locator = new UnityMvcServiceLocator(container);

ServiceLocator.SetLocatorProvider(() =&gt; locator);
MvcServiceLocator.SetCurrent(locator);
</pre>

<p>This allows you to access the same locator either via the MvcServiceLocator.Current instance or the ServiceLocator.Current instance.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/08/mvc-3-preview-1-vs-2010-template-w-razor-html-5-boilerplate-and-openid-authentication/">MVC 3 RC VS 2010 Template w/ Razor, Html 5 Boilerplate and OpenId Authentication</a></h1>
        <span class="post-date">Aug 25 2010</span>
        

<p>### Updated 3/21/2011:</p>

<p>Now with twitter and oauth support. See [the latest update](<a href="http://www.michaelhamrah.com/blog/2011/03/updated-mvc3-html5-boilerplate-template-now-with-twitter-and-facebook/">http://www.michaelhamrah.com/blog/2011/03/updated-mvc3-html5-boilerplate-template-now-with-twitter-and-facebook/</a>)</p>

<p>You can pull the source files from the <a href="http://github.com/mhamrah/Html5OpenIdTemplate">GitHub page</a>, or <a href="https://github.com/downloads/mhamrah/Html5OpenIdTemplate/Html5OpenIdTemplate.zip">download the zip containing the template</a>.</p>

<p>I&#8217;ve created an (arguably) bare-minimum Visual Studio 2010 Template for getting started with MVC 3 Preview 1 using the Razor view engine and some other web goodies. I got tired of the vanilla &#8220;Welcome to MVC&#8221; homepage and I&#8217;m not a fan of the MembershipProvider abstraction and all the Account junk included by default.  This template is meant to provide a bare-bones setup of Html 5 and provide OpenId authentication for users (but not full-on user management)- it&#8217;s a simple cocktail of Html5 Boilerplate and DotNetOpenAuth.  The rest is left up to you to build up!</p>

<h3 id="span-style-font-weight-normal-paul-irish-8217-s-html5-boilerplate-span:c85e8e12a9a51fb10d19524cb483b402"><span style="font-weight: normal;">Paul Irish&#8217;s Html5 Boilerplate</span></h3>

<p>Paul Irish created a nice starting point for Html5 websites with his <a href="http://html5boilerplate.com/">Html5 Boilerplate</a>.  There&#8217;s a lot of goodies in it which go beyond just changing the DOCTYPE.  <a href="http://net.tutsplus.com/tutorials/html-css-techniques/the-official-guide-to-html5-boilerplate/?utm_source=feedburner&amp;utm_medium=feed&amp;utm_campaign=Feed:+nettuts+(NETTUTS)">Check out the  NetTuts+ official guide to Html5 Boilerplate explained by Paul himself</a>.  I&#8217;ve ported over the .9 version with comments so you can see what&#8217;s what.  The only changes made where to replace the url&#8217;s in script and link tags with @Url.Content methods.  The original index page is at the root (you&#8217;ll want to delete, but it&#8217;s a handy reference) and the _Layout.cshtml now has a Header and Script section to use in child pages.  This functionality is used in the LogOn view to set up OpenId authentication.</p>

<h3 id="span-style-font-weight-normal-openid-with-dotnetopenauth-span:c85e8e12a9a51fb10d19524cb483b402"><span style="font-weight: normal;">OpenId with DotNetOpenAuth</span></h3>

<p>I was never a fan of the stock MembershipProvider infrastructure and setup of the sql tables required for user management.  Usually, user management requires very specific needs site to site, and the default functionality gets butchered anyway.  So all that stuff gets pulled and replaced with the ease and simplicity of OpenId.  The template uses the <a href="http://code.google.com/p/openid-selector/">OpenId Selector</a> on the login page and <a href="http://www.dotnetopenauth.net/">DotNetOpenAuth</a> with Forms Authentication on the backend.  There&#8217;s no Register page, as the specifics of the required user schema varies too much.  But you should be able to combine the OpenId logic on the Login page with a new Register page to suit your needs.  There&#8217;s also no persistence store integrated into the template as that is left entirely up to you.</p>

<h3 id="span-style-font-weight-normal-future-plans-span:c85e8e12a9a51fb10d19524cb483b402"><span style="font-weight: normal;">Future Plans</span></h3>

<p><span style="font-weight: normal;">I really have no set goals for this template, so it will evolve in a free form manner.  The <a href="http://github.com/mhamrah/Html5OpenIdTemplate">code is on GitHub</a> so feel free to branch and edit as necessary.  I&#8217;m going to add some unit tests around the OpenId logic, and possibly evolve the Account creation in some way.  So that&#8217;s about it!</span></p>

<h3 id="span-style-font-weight-normal-downloads-span:c85e8e12a9a51fb10d19524cb483b402"><span style="font-weight: normal;">Downloads</span></h3>

<p><span style="font-weight: normal;">You can pull the source files from the <a href="http://github.com/mhamrah/Html5OpenIdTemplate">GitHub page</a>, or <a href="http://www.michaelhamrah.com/blog/wp-content/uploads/2010/11/Html5OpenIdTemplate.zip">download the zip containing the template</a>.</span></p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/08/the-new-webapp-architecture-asp-net-mvc-3-jquery-templating-with-pure-and-the-json-value-provider/">The New Web App Architecture: ASP.NET MVC 3, jQuery Templating with PURE and the Json Value Provider</a></h1>
        <span class="post-date">Aug 4 2010</span>
        

<p>Over the past couple of years there has been a slow progression in the .NET web app world to fully separate out client/server interaction.  Long gone are the horrible days of ViewState and Events; MVC provided a nice step to better structure web applications for powerful Web 2.0 experiences.  But the barrier between client and server interaction has never really been clean-  MVC markup has always been littered with C# code and there hasn&#8217;t always been widespread tools available to easily build desktop class applications in the browser.  Sure, spark and haml provide alternatives, but these are essentially make a core problem easier to bear.</p>

<p>With the new preview of MVC 3, we can eliminate that core problem of server based html rendering: the built in Json Support via the JsonValueProviderFactory along with some jQuery goodies presents us with the new web app architecture: service- orientated web apps built with a rich, js based client driven by Json based services.  Using core tools of html, css, and js and not requiring the overhead of Silverlight, Flash, or JS based web frameworks.  This JSON functionality, combined with javascript templating using <a href="http://beebole.com/pure/">PURE</a> gives us the ability to break free from the static html navigation and build dynamic apps in much more efficient ways.</p>

<h3 id="asp-net-mvc-3-and-the-jsonvalueproviderfactory:5f5fe724d58710160addd90aba3904ae">ASP.NET MVC 3 and the JsonValueProviderFactory</h3>

<p><a href="http://weblogs.asp.net/scottgu/archive/2010/07/27/introducing-asp-net-mvc-3-preview-1.aspx">Scott Guthrie writes about the new ASP.NET MVC 3 preview features</a>, and among the hype is the default Json support for action methods.  In his blog post he forgets one crucial step to actually make this work, which is adding the new JsonValueProviderFactory to the global value provider factories class in the Application start method of the global.asax, like so:</p>

<pre class="syntax c#">protected void Application_Start()
{
    AreaRegistration.RegisterAllAreas();

    //Must add this factory explicitly (for now, at least):
    ValueProviderFactories.Factories.Add(new JsonValueProviderFactory());

    RegisterGlobalFilters(GlobalFilters.Filters);
    RegisterRoutes(RouteTable.Routes);
}
</pre>

<p>Once this is in place we can treat our controller actions as usual, even when using Json.  The serialization mechanism is agnostic (this is pretty much exactly the same as Scott&#8217;s code):</p>

<pre class="syntax c#">[HttpPost]
public ActionResult Search(ImageSearchInput input)
{
    //AssetSearchInput can be posted via Json
    return new JsonResult() { Data = new { ImageInfo = new Repository.ImageRepository().Search(input).Images } };
}
</pre>

<p>ImageSearchInput, with a string property of &#8220;Caption&#8221;, will be built from the Json data posted to the server by the following Ajax call:</p>

<pre class="syntax js">$('#search').submit(function () {
  var input = { Caption: $('#caption').val() };

  $.ajax({url: '/Home/Search',
    type: 'POST',
    data: JSON.stringify(input),
    dataType: 'json',
    contentType: 'application/json; charset=utf-8',
    success: function (data) {
        $('.imgContainer').autoRender(data);
    }
  });

  return false;
});
</pre>

<p>The server will route the request to the Home/Search method, and will serialize the posted data in the ImageSearchInput class.  As long the properties match up and are of the correct type, the deserialization will be fluid.  Notice how we don&#8217;t actually need to specify the ImageSearchInput class name when building the Json object.</p>

<p>Those with keen eyes may have noticed the success: callback containing the autoRender() function.  This is the [Over the past couple of years there has been a slow progression in the .NET web app world to fully separate out client/server interaction.  Long gone are the horrible days of ViewState and Events; MVC provided a nice step to better structure web applications for powerful Web 2.0 experiences.  But the barrier between client and server interaction has never really been clean-  MVC markup has always been littered with C# code and there hasn&#8217;t always been widespread tools available to easily build desktop class applications in the browser.  Sure, spark and haml provide alternatives, but these are essentially make a core problem easier to bear.</p>

<p>With the new preview of MVC 3, we can eliminate that core problem of server based html rendering: the built in Json Support via the JsonValueProviderFactory along with some jQuery goodies presents us with the new web app architecture: service- orientated web apps built with a rich, js based client driven by Json based services.  Using core tools of html, css, and js and not requiring the overhead of Silverlight, Flash, or JS based web frameworks.  This JSON functionality, combined with javascript templating using <a href="http://beebole.com/pure/">PURE</a> gives us the ability to break free from the static html navigation and build dynamic apps in much more efficient ways.</p>

<h3 id="asp-net-mvc-3-and-the-jsonvalueproviderfactory-1:5f5fe724d58710160addd90aba3904ae">ASP.NET MVC 3 and the JsonValueProviderFactory</h3>

<p><a href="http://weblogs.asp.net/scottgu/archive/2010/07/27/introducing-asp-net-mvc-3-preview-1.aspx">Scott Guthrie writes about the new ASP.NET MVC 3 preview features</a>, and among the hype is the default Json support for action methods.  In his blog post he forgets one crucial step to actually make this work, which is adding the new JsonValueProviderFactory to the global value provider factories class in the Application start method of the global.asax, like so:</p>

<pre class="syntax c#">protected void Application_Start()
{
    AreaRegistration.RegisterAllAreas();

    //Must add this factory explicitly (for now, at least):
    ValueProviderFactories.Factories.Add(new JsonValueProviderFactory());

    RegisterGlobalFilters(GlobalFilters.Filters);
    RegisterRoutes(RouteTable.Routes);
}
</pre>

<p>Once this is in place we can treat our controller actions as usual, even when using Json.  The serialization mechanism is agnostic (this is pretty much exactly the same as Scott&#8217;s code):</p>

<pre class="syntax c#">[HttpPost]
public ActionResult Search(ImageSearchInput input)
{
    //AssetSearchInput can be posted via Json
    return new JsonResult() { Data = new { ImageInfo = new Repository.ImageRepository().Search(input).Images } };
}
</pre>

<p>ImageSearchInput, with a string property of &#8220;Caption&#8221;, will be built from the Json data posted to the server by the following Ajax call:</p>

<pre class="syntax js">$('#search').submit(function () {
  var input = { Caption: $('#caption').val() };

  $.ajax({url: '/Home/Search',
    type: 'POST',
    data: JSON.stringify(input),
    dataType: 'json',
    contentType: 'application/json; charset=utf-8',
    success: function (data) {
        $('.imgContainer').autoRender(data);
    }
  });

  return false;
});
</pre>

<p>The server will route the request to the Home/Search method, and will serialize the posted data in the ImageSearchInput class.  As long the properties match up and are of the correct type, the deserialization will be fluid.  Notice how we don&#8217;t actually need to specify the ImageSearchInput class name when building the Json object.</p>

<p>Those with keen eyes may have noticed the success: callback containing the autoRender() function.  This is the]<a href="http://beebole.com/pure">3</a> javascript templating engine at work.  I came across PURE when reading about the <a href="http://wiki.github.com/nje/jquery/jquery-templates-proposal">jQuery templating proposal on GitHub</a> and was immediately drawn to its simplistic syntax.</p>

<p>The philosophy behind PURE is simple: instead of interleaving markup and template directives (which, to be honest, is just as bad as mixing code with markup), PURE can make assumptions about what to repeat and what to bind based on css class names and Json property names.</p>

<p>Let&#8217;s say I had the following json markup:</p>

<pre class="syntax js">var data = {
    Image:
        { Filename: 'mypic1.jpg', ImageUrl: '/images/mypic1.jpg'},
        { Filename: 'agoodphoto.jpg', ImageUrl: '/images/agoodphoto.jpg'}
}
</pre>

<p>This is simply an Array with two objects in it.  Using PURE&#8217;s autoRender function, we can specify binding directives using CSS classes, building li elements and populating content as appropriate:</p>

<pre class="syntax html escaped">&lt;ul class="imgContainer"&gt;
    &lt;li class="Image"&gt;
        &lt;p&gt;&lt;img class="ImageUrl@src" /&gt;&lt;/p&gt;
        &lt;p class="info"&gt;&lt;span class="Filename"&gt;&lt;/span&gt;&lt;/p&gt;
    &lt;/li&gt;
&lt;/ul&gt;
</pre>

<p>Because the li has the Image css class, and we have an array of Image objects, PURE will duplicate the li contents for each element in the array.  The span tag will show the filename property because it has the Filename css class.  The src attribute of the img tag will get the ImageUrl property because it is using the @ directive, which simply says &#8220;put the ImageUrl property in the src attribute&#8221;.  PURE can easily get it&#8217;s own post, but the point is simple:  we no longer need to generate server side html for displaying complex content.  Even though this has always been possible before, it hasn&#8217;t been as fluid as PURE.  Another primary benefit is that we can send incredibly complex Json data back to the client which can update numerous page snippets.  Orchestrating multi-updates, like a detail page, shopping cart, or other areas simultaneously has not been trivial, but because we have json data and templating these complex scenarios are easily achievable.</p>

<h3 id="gotchas:5f5fe724d58710160addd90aba3904ae">Gotchas</h3>

<p>Client side templating is dangerous- you don&#8217;t really know how well the client&#8217;s computer it is.  Be mindful of performance and memory requirements, and ensure you&#8217;re targeting the right browsers.  Chrome&#8217;s V8 javascript engine has evolved remarkably well in handling javascript intensive applications.</p>

<p>As for the MVC 3 preview, I wish we saw dynamic results from controllers: specifically, one action to return either  Json, Xml, or Html output based on some request directive.  This is possible with various ActionResults or ActionFilters, and there&#8217;s some functionality already out there to do it, but it isn&#8217;t as nice as Ruby on Rail&#8217;s respond_to functionality.  A single action supporting multiple outputs will allow developers to easily target various platforms and scenarios in the web world.</p>

<h3 id="final-thoughts:5f5fe724d58710160addd90aba3904ae">Final Thoughts</h3>

<p>Despite techniques of Json serialization and jQuery templating already existing in the ecosystem, it has never been as robust and integrated as with the new MVC 3 support (sure, Rails has had this for a while).  Combining this functionality with templating tools like PURE will open up new development paths for rich web applications based entirely on standard tools like javascript, html, and css without relying on chunky js frameworks.  Keeping core tools simple means having the ability to build out specific functionality as needed, rather than getting boxed into more complete frameworks.  From the managing side, it also keeps the available pool of developers large so you&#8217;re not requiring knowledge on a specific tool.  Play around with these tools and see what you can do!</p>

<p><a rev="vote-for" href="http://dotnetshoutout.com/The-New-Web-App-Architecture-ASPNET-MVC-3-jQuery-Templating-with-PURE-and-the-Json-Value-Provider-Adventures-in-HttpContext"><img alt="Shout it" src="http://dotnetshoutout.com/image.axd?url=http%3A%2F%2Fwww.michaelhamrah.com%2Fblog%2F2010%2F08%2Fthe-new-webapp-architecture-asp-net-mvc-3-jquery-templating-with-pure-and-the-json-value-provider%2F" style="border:0px" /></a></p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/03/building-a-single-speed-wheel-building/">Building a Single Speed: Wheel Building</a></h1>
        <span class="post-date">Mar 16 2010</span>
        

<p>By far the trickiest part of building the single speed bike (and, consequently, the most fun) was building the wheel.  I was a little hesitant to take on wheel assembly, but I couldn&#8217;t cop out and not try to give it a shot.  It turns out, it&#8217;s rather easy and a lot of fun.  Once you get the pattern down lacing the spokes is pretty straightforward, and out of all the parts of bike building this step really connects you to the bike.<figure id="attachment_372" style="width: 300px;" class="wp-caption alignleft"></p>

<p><a href="http://i0.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0198.jpg"><img class="size-medium wp-image-372" title="Wheel building, step one" src="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0198-300x200.jpg?resize=300%2C200" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">The first round of spokes are in. Luckily, the Rebel Yell was close at hand.</figcaption></figure></p>

<h4 id="the-wheels:9e3d2c3958c1dead2d18ffd299d6579c">The Wheels</h4>

<p>The wheels are a pair of <a href="http://www.velocityusa.com/default.asp?contentID=583">Velocity Deep V</a>&#8216;s with Origin-8 branded hubs (they&#8217;re actually made by Formula).  The spokes are DT Champions.  Luckily, I didn&#8217;t have to worry about <a href="http://www.bikeschool.com/spokes/">calculating spoke length</a> because I ordered everything from <a href="http://www.ridebrooklynny.com">Ride Brooklyn</a> (a great bike store in Park Slope) and they took care of the details.</p>

<h4 id="videos:9e3d2c3958c1dead2d18ffd299d6579c">Videos</h4>

<p>I did a lot of research before I got started.  Books weren&#8217;t that helpful, as you really need to learn by example to mimic what&#8217;s going on as you lace the spokes.  I found the <a href="http://www.youtube.com/watch?v=qTb3x5VO69Y&amp;feature=related">best video on building a 36 hole front wheel from the bike tube</a> on YouTube. I&#8217;d just skip to <a href="http://www.youtube.com/watch?v=AOI3uBztvHc">wheel building part two</a> where the action starts.  <a href="http://www.youtube.com/watch?v=OYl4NO5m16Q&amp;feature=related">The bike tube also has two videos on lacing a 32 hole rear wheel</a>.  It&#8217;s the same lacing pattern, but the video goes into a little more depth when building the wheel.  The three cross pattern (which means a spoke crosses three other spokes between the hub and rim) is the same between front and rear wheels.<figure id="attachment_373" style="width: 300px;" class="wp-caption alignright"></p>

<p><a href="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0201.jpg"><img class="size-medium wp-image-373 " title="MLH_0201" src="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0201-300x201.jpg?resize=300%2C201" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">The first set of spokes are in. Notice the spoke next to the valve hole. The second set of spokes should go in to the right of this one, so it doesn&rsquo;t straddle the valve hole. Or, you can start one away from the valve hole, and string the second set between the valve hole and the first spoke. The alternate side spoke goes in the flange hole immediately adjacent to the spoke on the opposite side.</figcaption></figure></p>

<p>I recommend watching both sets.  The approach is a little different in that the 32 hole front wheel has you lace one side first, then the other, while the 36 hole rear wheel has you lace alternate sides (you put in for sets of spokes: the &#8220;innies&#8221; and &#8220;outies&#8221; on both the left and right flange).  The valve hole ends up being in a different place with the rear wheel video- as the author explains, you want it to be between a parallel set of spokes to make using the valve easier.  With the front wheel video the valve ends up being between a slanted set of spokes (I could have also followed the video incorrectly).  Not a big deal; it&#8217;s just a nuanced difference.</p>

<p>I recommend following the 36 hole front wheel video- it&#8217;s a little easier to get the hub centered in the flange because you lace alternate sides.  My rims have 32 holes and there really isn&#8217;t any difference in building the wheel.  (A 36 hole wheel has 4 sets of 9 spokes each, while a 32 hole wheel only has 8 spokes per set).<figure id="attachment_374" style="width: 300px;" class="wp-caption alignleft"></p>

<p><a href="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0202.jpg"><img class="size-medium wp-image-374" title="MLH_0202" src="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0202-300x200.jpg?resize=300%2C200" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">I followed the 32 hole rear wheel video, which laces one side at a time. It proved difficult to lace the 2nd side because the hub wasn&rsquo;t centered.</figcaption></figure></p>

<h4 id="getting-started:9e3d2c3958c1dead2d18ffd299d6579c">Getting Started</h4>

<p>I followed the rear wheel video because it was more succinct.  However, I messed up in the process and had to start again.  I laced one side, and the hub was off center- one side was flush with the rim.  This made lacing the second side very difficult, as there wasn&#8217;t a lot of give in the hub.  I also had a hard time figuring out where to start lacing on the second side.  I started with the wrong hole, and the hub got very twisted half way through the second side.  I really had to pull to get the nipples connected.  When it proved extremely difficult, I knew I must be doing something wrong.  <strong>If you&#8217;re fighting the wheel, stop and restart.  You missed something.</strong> After starting again, I realized where I went wrong the first time with the second set of spokes on the other side.<figure id="attachment_377" style="width: 300px;" class="wp-caption alignright"></p>

<p><a href="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0229.jpg"><img class="size-medium wp-image-377" title="MLH_0229" src="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0229-300x200.jpg?resize=300%2C200" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">Notice how the second set of spikes line up with the valve hole. This will put the valve hole between parallel spokes.</figcaption></figure></p>

<h4 id="try-and-try-again:9e3d2c3958c1dead2d18ffd299d6579c">Try, and Try Again</h4>

<p>When I attempted to build the wheel again, using the front wheel video, the process was a piece of cake.  Every spoke went in without a hitch.  The benefit of alternating sides while lacing is the hub is centered in the rim which makes connecting the spokes to the nipples very easy (although, I could have messed that up too when following the rear wheel video).</p>

<p>The only glitch (which was a minor issue) is when I did the first wheel the valve hole didn&#8217;t end up between parallel spots.  I either messed up following the video, or the front wheel video didn&#8217;t make a point to lace the wheel in such a way.  The rear wheel video does explicitly call this out.  As long you don&#8217;t end up with the valve hole in a cross spoke triangle you&#8217;re all set.  Then it will be impossible to fill the tire with air.<figure id="attachment_378" style="width: 300px;" class="wp-caption alignleft"></p>

<p><a href="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/comparison.jpg"><img class="size-medium wp-image-378 " title="comparison" src="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/comparison-300x201.jpg?resize=300%2C201" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">It&rsquo;s a nuanced difference, but you want the valve hole between parallel spots.</figcaption></figure></p>

<p>Correcting the error when I did the rear wheel was easy- I just started one hole away from the valve hole, rather than right next to the valve hole.  After I twisted the hub to get the spoke slant to start the second side, I made sure I started the second side next to the valve hole.  This way the two slanted spokes are next to the valve hole, rather than straddling it.  This will put the valve hole between parallel spokes.<figure id="attachment_375" style="width: 300px;" class="wp-caption alignright"></p>

<p><a href="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0211.jpg"><img class="size-medium wp-image-375" title="MLH_0211" src="http://i0.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0211-300x200.jpg?resize=300%2C200" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">The wheel after lacing the second side.</figcaption></figure></p>

<h4 id="truing:9e3d2c3958c1dead2d18ffd299d6579c">Truing</h4>

<p>Once I got all the spokes on the wheel I dropped some wet lube on the nipples and tightened every spoke with a screwdriver until only a couple threads remained.  The front wheel came out pretty straight, but the rear wheel was way off.  It just took a little more work with the spoke wrench to get it center.  I came up with a make shift truing stand with the front fork and some plastic sticky tabs (I needed to use the frame to do the rear wheel, but it&#8217;s the same idea).<figure id="attachment_379" style="width: 300px;" class="wp-caption alignleft"></p>

<p><a href="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0008.jpg"><img class="size-medium wp-image-379" title="MLH_0008" src="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0008-300x200.jpg?resize=300%2C200" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">Awesome makeshift truing stand, with helpful plastic sticky tabs used in lieu of calipers.</figcaption></figure></p>

<p>I placed the sticky tabs as close as possible to the frame and spun the wheel (the wheel spun forever- the hubs must be really slick!).  When the frame hit the tab it would make a noise, and I would adjust.  It&#8217;s really hard to see the space shift between the tab and the rim.  The noise thing really helped.  Slow and calculated increments worked best- you really only need a quarter turn.  This approach worked for both the horizontal and vertical trueness.</p>

<p>I have no way of properly checking the dish, so I may need to take a trip to the bike store (dish is making sure the hub is centered on the rim).  I&#8217;m also worried that the spokes are too tight.  I read that you shouldn&#8217;t have a lot of spoke tension- the spokes feel firm but I definitely need a second opinion.</p>

<h4 id="what-8217-s-next:9e3d2c3958c1dead2d18ffd299d6579c">What&#8217;s Next</h4>

<p>I&#8217;m hoping to get the rest of the parts tomorrow to finish this build.  I&#8217;ll have another post to show how it all came together!</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/03/building-a-single-speed-bike/">Building a Single Speed Bike with a 183rd Street Frame</a></h1>
        <span class="post-date">Mar 15 2010</span>
        

<p>As we&#8217;re getting ready to gear up for summer, my wife was looking for a new bike.  I wanted to get her something cool and unique, and (selfishly) use the opportunity to indulge myself in a bike building project.  I heard building a bike was a pretty straightforward process, and in a worse case scenario I&#8217;ll just bring the parts to a bike shop and have them finish it up.  We knew we wanted to go with a single speed- a friend has a <a href="http://www.trekbikes.com/us/en/bikes/urban/soho/sohos/">Trek Soho S</a> which I fell in love with.  A single speed is perfect for jetting around the city- really light and nimble.  The acceleration is surprisingly easy and you hit a nice cruising speed quickly.  I&#8217;m anxiously awaiting to compare this custom build with other commercial bikes.</p>

<h4 id="the-bike:5375a95adfae0af00b50d08588b7f5bf">The Bike</h4>

<p>We headed over to the good folks at <a href="http://www.ridebrooklynny.com">Ride Brooklyn</a> for a recommendation on what to buy.  It&#8217;s a great bike shop with a really friendly and helpful staff.  My wife wanted something light and we both wanted to keep the cost down.  They had two frames handy for comparison: An Origin-8 track frame and a slightly more expensive <a href="http://183rdstreet.com">183rd Street</a> track frame.  The 183rd Street frame was a lot lighter than the Origin-8 (surprisingly so) and has a nice powder coat paint job in black which gives it a cool matte finish.  The owner built a bike using the same frame, so we figured it was the way to go.  My wife is 5&#8217;4&#8243; and we got the 51cm frame and fork.<figure id="attachment_357" style="width: 300px;" class="wp-caption aligncenter"></p>

<p><a href="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0196.jpg"><img class="size-medium wp-image-357  " title="Getting Ready for the Bike Build" src="http://i0.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0196-300x200.jpg?resize=300%2C200" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">Half the parts ready to go. My boss says only in NYC do you build a bike in the kitchen.</figcaption></figure></p>

<p style="text-align: left;">
  We also got a pair of Velocity Deep V rims in lime green with Formula hubs and a purple Origin-8 crank.  Once I saw everything together this bike is definitely getting a nickname: &#8220;The Joker&#8221;.
</p>

<p><strong>The Build: Bottom Bracket</strong></p>

<p><a href="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0003.jpg"><img class="alignleft size-medium wp-image-360" title="MLH_0003" src="http://i0.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0003-300x200.jpg?resize=300%2C200" alt="" data-recalc-dims="1" /></a>With parts in hand, it&#8217;s time to get building!  I started with the bottom bracket, which is an Origin-8 cartridge style bracket with a length of 107mm.  It turns out I should have gotten the 103mm, but the 107 will work just fine.  Check the specifications of your crank to find out for sure (I thought it would have to do with the frame, but it&#8217;s sized for the crank).  I followed this <a href="http://bicycletutor.com/cartridge-bottom-bracket/">video from Bicycle Tutor</a> to find out what to do.  It&#8217;s pretty straightforward.  Honestly, the hardest part was figuring out how to get the lock cup off the bottom bracket.  Hint: You just pull it off!  I kept turning it and was afraid to pull too hard.  Turns out, not a big deal.  I borrowed a bottom bracket tool, but didn&#8217;t have a torque wrench to find the right <a href="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0007-Edit.jpg"><img class="alignright size-medium wp-image-361" title="MLH_0007-Edit" src="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0007-Edit-300x209.jpg?resize=300%2C209" alt="" data-recalc-dims="1" /></a>resistance.  Using some polylube 1000 to grease the threads,  I just screwed the bracket until it was pretty tight and checked the turn on the spindle.  Seemed alright.  I couldn&#8217;t get the lock cup flush with the frame on the non drive side, but it turns out this isn&#8217;t a big deal.</p>

<h4 id="the-headset:5375a95adfae0af00b50d08588b7f5bf">The Headset</h4>

<p>The 183rd Street frame has a threadless 1 <sup>1</sup>&frasl;<sub>8</sub>&#8243; headtube.  I picked up a Crane Creek threadless headset, and, funny enough, used their great <a href="http://www.canecreek.com/tech-headsets?view=video">video on how to install a threadless headset</a>.  I didn&#8217;t have a threadless headset press, and tried using a 2&#215;4 and a hammer to get the bottom and top cups on.  It didn&#8217;t work.  Lesson learned: <strong>Don&#8217;t try using a hammer to bang your threadless headset on the frame.</strong><figure id="attachment_362" style="width: 150px;" class="wp-caption alignleft"></p>

<p><a href="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0005.jpg"><img class="size-thumbnail wp-image-362  " title="MLH_0005" src="http://i1.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0005-150x150.jpg?resize=150%2C150" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">Headset fully pressed on frame, but text is off center</figcaption></figure> <figure id="attachment_363" style="width: 150px;" class="wp-caption alignright"><a href="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0006.jpg"><img class="size-thumbnail wp-image-363 " title="MLH_0006" src="http://i2.wp.com/www.michaelhamrah.com/blog/wp-content/uploads/2010/03/MLH_0006-150x150.jpg?resize=150%2C150" alt="" data-recalc-dims="1" /></a><figcaption class="wp-caption-text">Fork with crown race installed. You can see the sticky tabs I used to true the wheel.</figcaption></figure></p>

<p>You need the right tool for the job.  I didn&#8217;t want to buy a tool, so I brought the headset and frame back to Ride Brooklyn (I should start a side bet to see how many times I need to go back there!) and they pressed the cups on the frame, and used a crown race setter to put the crown race on the fork.  I did mess up a little bit, because I forgot to center the logo on the cups when I put them on the frame. I already had them half on when I went to the store and didn&#8217;t want to deal with taking them off again.</p>

<h4 id="next-steps:5375a95adfae0af00b50d08588b7f5bf">Next Steps</h4>

<p>Lacing and truing the wheel was a fun but tedious process.  I&#8217;ll write about that next as well as putting the other parts together, so check out the <a href="http://www.michaelhamrah.com/blog/tag/bikebuild">BikeBuild tag</a> to follow on the progress.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="http://blog.michaelhamrah.com/2010/02/proposal-lets-call-asp-net-mvc-mvc/">Proposal: Let’s call ASP.NET MVC “.MVC”</a></h1>
        <span class="post-date">Feb 18 2010</span>
        <p>I hereby propose renaming ASP.NET MVC to just &#8220;.MVC&#8221;. It&#8217;s just so much easier to type.</p>

    </div>
  
</div>

<div class="pagination">
  
  <a class="pagination-item older" href="http://blog.michaelhamrah.com/page/7/">Older</a>
  

  
  <a class="pagination-item newer" href="http://blog.michaelhamrah.com/page/5/">Newer</a>
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>

