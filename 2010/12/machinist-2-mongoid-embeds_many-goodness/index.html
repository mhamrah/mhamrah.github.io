<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Machinist 2 &#43; Mongoid &#43; Embeds_Many Goodness &middot; Adventures in HttpContext
    
  </title>

  
  <link rel="stylesheet" href="http://blog.michaelhamrah.com/css/poole.css">
  <link rel="stylesheet" href="http://blog.michaelhamrah.com/css/syntax.css">
  <link rel="stylesheet" href="http://blog.michaelhamrah.com/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.michaelhamrah.com/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="http://blog.michaelhamrah.com/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.michaelhamrah.com/atom.xml">
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Michael Hamrah</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="http://blog.michaelhamrah.com/">Home</a>
    <a class="sidebar-nav-item " href="http://blog.michaelhamrah.com/post">Posts</a>

    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a class="sidebar-nav-item " href="http://blog.michaelhamrah.com/about/">About</a>
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="http://linkedin.com/in/hamrah">LinkedIn</a>
    <a class="sidebar-nav-item" href="http://twitter.com/mhamrah">@mhamrah</a>
    <a class="sidebar-nav-item" href="http://github.com/mhamrah">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="http://blog.michaelhamrah.com/" title="Home">Adventures in HttpContext</a>
            <small>All the stuff after &#39;Hello, World&#39;</small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">Machinist 2 &#43; Mongoid &#43; Embeds_Many Goodness</h1>
  <span class="post-date">Dec 10 2010</span>
  <p>I had a heck of a time getting fixtures working with <a href="http://mongoid.org/">Mongoid</a> when it came to a required embeds<em>many property.  No matter what I did, I kept getting an error: &#8220;_Access to the collection for</em> XXX <em>is not allowed since it is an embedded document, please access a collection from the root document.&#8221;</em></p>

<p>Then I stumbled upon <a href="https://github.com/notahat/machinist">Machinist</a> v2 and the <a href="https://github.com/nmerouze/machinist_mongo">machinist_mongo</a> gem which solved the problem.  And it had a nice API, to boot!</p>

<p><strong>Getting Started</strong></p>

<p>As of this post, you&#8217;ll need to pull the machinist_mongo gem directly from git and get the machinist2 branch.  That&#8217;s easy with Rails 3:</p>

<p><strong>gem &#8216;machinist_mongo&#8217;, :git =&gt; &#8216;<a href="https://github.com/nmerouze/machinist_mongo.git&amp;#8217">https://github.com/nmerouze/machinist_mongo.git&amp;#8217</a>;, :require =&gt; &#8216;machinist/mongoid&#8217;, :branch =&gt; &#8216;machinist2&#8242;</strong></p>

<p>Next, run</p>

<p><code class="syntax bash">bundle</code></p>

<p>to update your gems.</p>

<p>I&#8217;m using RSpec, so I put my blueprints in the spec/support/ directory so they get automatically loaded. Let&#8217;s say I have a User class with a :username and an embeds_many :authentications property (as if you&#8217;re following the Railscasts episode on using Devise and Omniauth).  The blueprint will look like this:</p>

<pre class="syntax ruby">Authentication.blueprint do
     uid { "user#{serial_number}" }
     provider { "machinist" }
end

User.blueprint do
     username { "user#{serial_number}" }
     authentications(1) { Authentication.make }
end
</pre>

<p>My authentications blueprint sets a unique id using the #{serial_number} counter in machinist 2. Then I&#8217;m declaring an array of one item in my authentications array, and calling Authentication.make to load the Authentication blueprint. This essentially lazy loads the authentications property via the root document, which is exactly what Mongoid wants, as there&#8217;s no Authentications table or root-level document.</p>

<p>Now you can build away using Machinist 2&#8217;s User.make (for creating an object without saving it) or make! (which makes and saves the object).</p>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-6576586-1', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

